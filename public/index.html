<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SadakaBox ü™ô</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container { max-width: 800px; margin: 0 auto; }
        
        header { text-align: center; margin-bottom: 30px; padding-top: 20px; }
        h1 { color: white; font-size: 2.5rem; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
        .subtitle { color: rgba(255,255,255,0.9); font-size: 1.1rem; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 600px) { .grid { grid-template-columns: 1fr; } }
        
        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }
        .card-full { grid-column: 1 / -1; }
        
        .box-visual { text-align: center; padding: 20px; }
        .sadaka-box {
            width: 150px;
            height: 130px;
            margin: 0 auto 20px;
            position: relative;
        }
        .box-body {
            width: 100%;
            height: 100px;
            background: linear-gradient(145deg, #e67e22, #d35400);
            border-radius: 0 0 12px 12px;
            position: absolute;
            bottom: 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .box-top {
            width: 100%;
            height: 40px;
            background: linear-gradient(145deg, #f39c12, #e67e22);
            border-radius: 12px 12px 4px 4px;
            position: absolute;
            top: 0;
        }
        .coin-slot {
            width: 60px;
            height: 6px;
            background: #2c3e50;
            border-radius: 3px;
            position: absolute;
            top: 28px;
            left: 50%;
            transform: translateX(-50%);
        }
        .coin {
            width: 40px;
            height: 40px;
            background: linear-gradient(145deg, #f1c40f, #f39c12);
            border-radius: 50%;
            position: absolute;
            left: 50%;
            top: -50px;
            transform: translateX(-50%);
            opacity: 0;
        }
        .coin.animating { animation: dropCoin 0.5s ease-in forwards; }
        @keyframes dropCoin { 0% { opacity: 1; top: -50px; } 100% { opacity: 0; top: 25px; } }
        
        .box-selector { margin-bottom: 20px; }
        .box-selector label {
            display: block;
            color: #666;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        .box-selector select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
        }
        .box-selector select:focus { outline: none; border-color: #667eea; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-item {
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }
        .stat-value { font-size: 2rem; font-weight: bold; color: #667eea; }
        .stat-label { font-size: 0.85rem; color: #666; margin-top: 5px; }
        .stat-value.total { color: #27ae60; }
        
        .actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn {
            flex: 1;
            min-width: 100px;
            padding: 14px 20px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: linear-gradient(145deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5); }
        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #e0e0e0;
        }
        .btn-secondary:hover { background: #e9ecef; }
        .btn-danger {
            background: #fff5f5;
            color: #e74c3c;
            border-color: #ffcdd2;
        }
        .btn-danger:hover { background: #ffe0e0; }
        
        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .coin-list { max-height: 300px; overflow-y: auto; }
        .coin-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        .coin-item:hover { background: #f8f9fa; }
        .coin-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(145deg, #f1c40f, #f39c12);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.2rem;
        }
        .coin-info { flex: 1; }
        .coin-date { font-weight: 500; color: #333; }
        .coin-location { font-size: 0.85rem; color: #666; }
        .coin-value { font-weight: 600; color: #27ae60; }
        
        .history-item {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            background: linear-gradient(145deg, #f8f9fa, #fff);
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .history-date { font-size: 0.85rem; color: #666; margin-bottom: 5px; }
        .history-stats { display: flex; gap: 20px; }
        .history-stat { font-weight: 600; }
        
        .empty-state { text-align: center; padding: 40px 20px; color: #666; }
        .empty-state-icon { font-size: 3rem; margin-bottom: 10px; }
        
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal h2 { margin-bottom: 20px; color: #333; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; color: #666; font-size: 0.9rem; margin-bottom: 5px; }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1rem;
        }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .modal-actions button { flex: 1; }
        .btn-cancel { background: #f8f9fa; color: #666; }
        
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; }
        .tab {
            padding: 10px 20px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 0.95rem;
            color: #666;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s;
        }
        .tab.active { color: #667eea; border-bottom-color: #667eea; font-weight: 600; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .api-link { text-align: center; margin-top: 20px; }
        .api-link a { color: rgba(255,255,255,0.8); text-decoration: none; }
        .api-link a:hover { color: white; }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            font-size: 0.95rem;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            z-index: 2000;
        }
        .toast.show { opacity: 1; transform: translateY(0); }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ü™ô SadakaBox</h1>
            <p class="subtitle">Track every coin, preserve every blessing</p>
        </header>
        
        <div class="grid">
            <!-- Box Visual & Selector -->
            <div class="card box-visual">
                <div class="sadaka-box">
                    <div class="coin" id="coin"></div>
                    <div class="box-top"><div class="coin-slot"></div></div>
                    <div class="box-body"></div>
                </div>
                
                <div class="box-selector">
                    <label>Select Box</label>
                    <select id="boxSelect" onchange="selectBox()">
                        <option value="">Loading...</option>
                    </select>
                </div>
                
                <div class="actions">
                    <button class="btn btn-secondary" onclick="openCreateModal()">üì¶ New</button>
                    <button class="btn btn-danger" onclick="deleteBox()">üóëÔ∏è Delete</button>
                </div>
            </div>
            
            <!-- Stats -->
            <div class="card" id="statsCard">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="coinCount">0</div>
                        <div class="stat-label">Coins</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value total" id="totalValue">$0</div>
                        <div class="stat-label">Total Value</div>
                    </div>
                </div>
                
                <div id="boxInfo" style="margin-bottom: 15px; text-align: center; color: #666; font-size: 0.9rem;">
                    Select a box to view details
                </div>
                
                <div class="actions">
                    <button class="btn btn-primary" id="addBtn" onclick="addCoin()">‚ûï Add Coin</button>
                    <button class="btn btn-secondary" onclick="emptyBox()">üîÑ Empty</button>
                </div>
            </div>
            
            <!-- Tabs: Recent Coins / History -->
            <div class="card card-full">
                <div class="tabs">
                    <button class="tab active" onclick="showTab('recent')">ü™ô Recent Coins</button>
                    <button class="tab" onclick="showTab('history')">üìú Collection History</button>
                </div>
                
                <div id="recentTab" class="tab-content active">
                    <div id="coinsList" class="coin-list">
                        <div class="empty-state">
                            <div class="empty-state-icon">ü™ô</div>
                            <p>No coins yet. Add your first coin!</p>
                        </div>
                    </div>
                </div>
                
                <div id="historyTab" class="tab-content">
                    <div id="historyList">
                        <div class="empty-state">
                            <div class="empty-state-icon">üìú</div>
                            <p>No collection history yet.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="api-link">
            <a href="/api/docs">üìö API Documentation</a>
        </div>
    </div>

    <!-- Create Box Modal -->
    <div class="modal-overlay" id="createModal">
        <div class="modal">
            <h2>üì¶ Create New Box</h2>
            <div class="form-group">
                <label>Box Name</label>
                <input type="text" id="newBoxName" placeholder="e.g., Ramadan Charity">
            </div>
            <div class="form-group">
                <label>Description (optional)</label>
                <input type="text" id="newBoxDesc" placeholder="e.g., For mosque renovation">
            </div>
            <div class="modal-actions">
                <button class="btn btn-cancel" onclick="closeCreateModal()">Cancel</button>
                <button class="btn btn-primary" onclick="createBox()">Create</button>
            </div>
        </div>
    </div>

    <!-- Add Coin Settings Modal -->
    <div class="modal-overlay" id="coinSettingsModal">
        <div class="modal">
            <h2>ü™ô Add Coin</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>Value</label>
                    <input type="number" id="coinValue" value="1" min="0.01" step="0.01">
                </div>
                <div class="form-group">
                    <label>Currency</label>
                    <select id="coinCurrency">
                        <option value="USD">USD ($)</option>
                        <option value="EUR">EUR (‚Ç¨)</option>
                        <option value="GBP">GBP (¬£)</option>
                        <option value="TRY">TRY (‚Ç∫)</option>
                        <option value="AED">AED (ÿØ.ÿ•)</option>
                        <option value="SAR">SAR (Ô∑º)</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Location (optional)</label>
                <input type="text" id="coinLocation" placeholder="e.g., Istanbul">
            </div>
            <div class="modal-actions">
                <button class="btn btn-cancel" onclick="closeCoinSettingsModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmAddCoin()">Add Coin</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        let boxes = [];
        let currentBox = null;
        let coins = [];
        let history = [];

        const boxSelect = document.getElementById('boxSelect');
        const coinCountEl = document.getElementById('coinCount');
        const totalValueEl = document.getElementById('totalValue');
        const boxInfoEl = document.getElementById('boxInfo');
        const coinsListEl = document.getElementById('coinsList');
        const historyListEl = document.getElementById('historyList');
        const coinEl = document.getElementById('coin');

        async function loadBoxes() {
            try {
                const res = await fetch('/api/boxes');
                if (res.ok) {
                    const data = await res.json();
                    boxes = data.boxes || [];
                    updateBoxSelect();
                }
            } catch (err) {
                showToast('Failed to load boxes');
            }
        }

        function updateBoxSelect() {
            boxSelect.innerHTML = boxes.length 
                ? boxes.map(b => `<option value="${b.id}">${b.name} (${b.count} coins)</option>`).join('')
                : '<option value="">No boxes - create one!</option>';
            if (boxes.length) selectBox();
        }

        async function selectBox() {
            const boxId = boxSelect.value;
            if (!boxId) { currentBox = null; updateDisplay(); return; }

            try {
                const [boxRes, coinsRes, historyRes] = await Promise.all([
                    fetch(`/api/boxes/${boxId}`),
                    fetch(`/api/boxes/${boxId}/coins?limit=10`),
                    fetch(`/api/boxes/${boxId}/collections?limit=5`)
                ]);

                if (boxRes.ok) {
                    const boxData = await boxRes.json();
                    currentBox = boxData.box;
                }
                if (coinsRes.ok) {
                    const coinsData = await coinsRes.json();
                    coins = coinsData.coins || [];
                }
                if (historyRes.ok) {
                    const historyData = await historyRes.json();
                    history = historyData.collections || [];
                }
                updateDisplay();
            } catch (err) {
                showToast('Error loading box data');
            }
        }

        function updateDisplay() {
            if (!currentBox) {
                coinCountEl.textContent = '0';
                totalValueEl.textContent = formatCurrency(0, 'USD');
                boxInfoEl.textContent = 'Select a box to view details';
                coinsListEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì¶</div><p>No box selected</p></div>';
                return;
            }

            coinCountEl.textContent = currentBox.count.toLocaleString();
            totalValueEl.textContent = formatCurrency(currentBox.totalValue, currentBox.currency || 'USD');
            boxInfoEl.textContent = currentBox.description || currentBox.name;

            updateCoinsList();
            updateHistoryList();
        }

        function updateCoinsList() {
            if (!coins.length) {
                coinsListEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ü™ô</div><p>No coins yet. Add your first coin!</p></div>';
                return;
            }

            coinsListEl.innerHTML = coins.map(coin => `
                <div class="coin-item">
                    <div class="coin-icon">ü™ô</div>
                    <div class="coin-info">
                        <div class="coin-date">${formatDate(coin.createdAt)}</div>
                        <div class="coin-location">${coin.location || 'Unknown'} ‚Ä¢ ${coin.ipAddress || 'Unknown IP'}</div>
                    </div>
                    <div class="coin-value">+${formatCurrency(coin.value, coin.currency)}</div>
                </div>
            `).join('');
        }

        function updateHistoryList() {
            if (!history.length) {
                historyListEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìú</div><p>No collection history yet.</p></div>';
                return;
            }

            historyListEl.innerHTML = history.map(h => `
                <div class="history-item">
                    <div class="history-date">üìÖ ${formatDate(h.emptiedAt)}</div>
                    <div class="history-stats">
                        <span class="history-stat">ü™ô ${h.coinsCollected} coins</span>
                        <span class="history-stat" style="color: #27ae60;">${formatCurrency(h.totalValue, h.currency)}</span>
                    </div>
                </div>
            `).join('');
        }

        function formatCurrency(amount, currency) {
            const symbols = { USD: '$', EUR: '‚Ç¨', GBP: '¬£', TRY: '‚Ç∫', AED: 'ÿØ.ÿ•', SAR: 'Ô∑º' };
            const symbol = symbols[currency] || currency;
            return `${symbol}${amount.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 2 })}`;
        }

        function formatDate(isoString) {
            if (!isoString) return 'Unknown';
            return new Date(isoString).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        function animateCoin() {
            coinEl.classList.remove('animating');
            void coinEl.offsetWidth;
            coinEl.classList.add('animating');
        }

        // Coin settings modal
        function openCoinSettingsModal() {
            document.getElementById('coinSettingsModal').classList.add('active');
        }

        function closeCoinSettingsModal() {
            document.getElementById('coinSettingsModal').classList.remove('active');
        }

        function addCoin() {
            if (!currentBox) return;
            openCoinSettingsModal();
        }

        async function confirmAddCoin() {
            closeCoinSettingsModal();
            animateCoin();

            const value = parseFloat(document.getElementById('coinValue').value) || 1;
            const currency = document.getElementById('coinCurrency').value;
            const location = document.getElementById('coinLocation').value.trim() || undefined;

            try {
                const res = await fetch(`/api/boxes/${currentBox.id}/coins`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: 1, value, currency, location })
                });

                if (res.ok) {
                    const data = await res.json();
                    currentBox.count = data.box.count;
                    currentBox.totalValue = data.box.totalValue;
                    currentBox.currency = data.box.currency;
                    coins.unshift(data.coins[0]);
                    if (coins.length > 10) coins.pop();
                    updateDisplay();
                    updateBoxSelect();
                    showToast(`Coin added! üí∞`);
                }
            } catch (err) {
                showToast('Failed to add coin');
            }
        }

        async function emptyBox() {
            if (!currentBox || currentBox.count === 0) {
                showToast('Box is already empty');
                return;
            }

            if (!confirm(`Empty "${currentBox.name}" and collect ${formatCurrency(currentBox.totalValue, currentBox.currency || 'USD')}?`)) {
                return;
            }

            try {
                const res = await fetch(`/api/boxes/${currentBox.id}/empty`, { method: 'POST' });
                if (res.ok) {
                    const data = await res.json();
                    currentBox.count = 0;
                    currentBox.totalValue = 0;
                    currentBox.currency = null;
                    coins = [];
                    history.unshift(data.collection);
                    updateDisplay();
                    updateBoxSelect();
                    showToast(data.message);
                }
            } catch (err) {
                showToast('Failed to empty box');
            }
        }

        async function deleteBox() {
            if (!currentBox) return;
            if (!confirm(`Delete "${currentBox.name}" permanently?`)) return;

            try {
                const res = await fetch(`/api/boxes/${currentBox.id}`, { method: 'DELETE' });
                if (res.ok) {
                    boxes = boxes.filter(b => b.id !== currentBox.id);
                    currentBox = null;
                    updateBoxSelect();
                    updateDisplay();
                    showToast('Box deleted');
                }
            } catch (err) {
                showToast('Failed to delete box');
            }
        }

        // Create box modal
        function openCreateModal() {
            document.getElementById('createModal').classList.add('active');
            document.getElementById('newBoxName').focus();
        }

        function closeCreateModal() {
            document.getElementById('createModal').classList.remove('active');
            document.getElementById('newBoxName').value = '';
            document.getElementById('newBoxDesc').value = '';
        }

        async function createBox() {
            const name = document.getElementById('newBoxName').value.trim();
            const description = document.getElementById('newBoxDesc').value.trim() || undefined;

            if (!name) { alert('Please enter a box name'); return; }

            try {
                const res = await fetch('/api/boxes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description })
                });

                if (res.ok) {
                    const data = await res.json();
                    boxes.push(data.box);
                    updateBoxSelect();
                    boxSelect.value = data.box.id;
                    selectBox();
                    closeCreateModal();
                    showToast('Box created! üéâ');
                }
            } catch (err) {
                showToast('Failed to create box');
            }
        }

        function showTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            if (tab === 'recent') {
                document.querySelector('.tab:first-child').classList.add('active');
                document.getElementById('recentTab').classList.add('active');
            } else {
                document.querySelector('.tab:last-child').classList.add('active');
                document.getElementById('historyTab').classList.add('active');
            }
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Event listeners
        document.getElementById('createModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('createModal')) closeCreateModal();
        });
        document.getElementById('coinSettingsModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('coinSettingsModal')) closeCoinSettingsModal();
        });
        document.getElementById('newBoxName').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') createBox();
        });

        // Init
        loadBoxes();
    </script>
</body>
</html>
